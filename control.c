#include <stdlib.h>
#include <math.h>
#include <stdio.h>
#include <stdbool.h>
#include <windows.h>

#include "physics.c"

#define FPS 60.0 // ???
#define delta_t (1.0 / FPS) // ?????????

// ??????????object??????
bool running_status = true; // ????

void sleep_micro(unsigned long m_seconds) { // ?????????????????
    LARGE_INTEGER freq, start, end; // ??????????????????i32?????LongLong(??i64)???????»…????win?????????????????????
    QueryPerformanceFrequency(&freq); // ???????????????????????i64???
    QueryPerformanceCounter(&start); // ????????????????
    // ??????????????????????????????????????????????????????????????????????????????????????

    double delta = 0; // ???????????????(??)
    double target_seconds = m_seconds / 1000000.0; // ??????????????????(???????)

    while (delta < target_seconds) {
        QueryPerformanceCounter(&end); // ???????????????
        delta = (double) (end.QuadPart - start.QuadPart) / freq.QuadPart; // ????????????
    }
}

unsigned long get_time() {  // ?????????????????????????????????
    LARGE_INTEGER freq, time;
    QueryPerformanceFrequency(&freq);
    QueryPerformanceCounter(&time);
    return (unsigned long)((double)time.QuadPart * 1000000.0 / freq.QuadPart);
}

int main() {

    vector square[4] = { // ?????????????????
        {-1,-1},{-1,1},{1,1},{1,-1}
    };
    // ????????????????????????????????????????????????????????????????, ?¶Ã?????init_polygonal??make_lines
    object car = init(square, 1000, (vector){0, 0}, 2, true); // ????????????????????????ß“?????

    vector board_init[4] = { // ???????????????
        {-1000, -1}, {-1000, 1}, {1000, 1}, {1000, -1},
    };
    object board = init(board_init, 1000, (vector){0, -100}, 1, false); // ????????
    object *obj_list[] = { &car, &board };

    // ?????????????
    const double fps = 60; // ???
    const double target_delta_t = 1 / fps; // ??????????????????????
    double frame_delta_time; // ???????????????????
    const unsigned long time_per_frame = 1000000 / fps; // ???????
    double accumulator = 0; // ?????????
    unsigned long start_time = get_time(); // ??????????????
    int len = sizeof(obj_list) / sizeof(object*);
    // double frame_start_time = 0; // ???????

    // ??????????ß÷????
    unsigned long frame_start = 0; // ??????????????
    int frame_count = 0; // ????????
    unsigned long frame_end_time, frame_start_time;
    frame_start_time = get_time();


    while (running_status) { // ???????????
        frame_start = get_time();

        frame_end_time = get_time();
        frame_delta_time = (double)(frame_end_time - frame_start_time) / 1000000;
        frame_start_time = frame_end_time;

        if (frame_delta_time > 0.25) {
            frame_delta_time = 0.25;
        }

        accumulator += frame_delta_time; // ???????????
        // printf("?????????");

        int index = 0;
        line** line_list = NULL;

        for (int i = 0; i < len; i++) { // ?????ßÿ???¶√????????
            int line_len = obj_list[i]->point_count * sizeof(line*); // ??????????????????????????
            object *obj = obj_list[i]; // ??????????????
            line* lines = make_lines(*obj); // ????????????????ß“?
            line** temp = realloc(line_list, (index + 1) * sizeof(line*)); // ?????????õg?????????????????
            if (temp == NULL) { // ??????????
                free(line_list);
                exit(EXIT_FAILURE);
            }
            line_list = temp; // ????????????????ß“?ß’??
            line_list[index] = lines;
            index++; // ????
            
        };
            /*??????ß’ß≥?????????????????????????????????????*/
            /*???*/

        for (int i = 0; i < len; i++) { // ??????????????active????active????????????
            // printf("?????????????");
            object *obj = obj_list[i];
            // printf("??????????");
            bool is_cross = false;
            if (obj->active == true) {
                int active_count = obj->point_count;
                // printf("?????ßÿ????");
                while (accumulator >= target_delta_t) { // ??????
                // printf("???????????");
                newton(obj);
            
                vector old_v = obj->v;
                // printf("%.16f, %.16f", old_v.x, old_v.y);
                car.v.x += car.a.x * target_delta_t;
                car.v.y += car.a.y * target_delta_t;
                
                update(old_v, obj, target_delta_t);

                if (line_list != NULL) {
                    if (i >= 0) {
                        if (line_list[i] != NULL) {free(line_list[i]);}
                        line_list[i] = make_lines(*obj);
                    }
                }

                accumulator -= target_delta_t;
                frame_count += 1;
                
                for (int j = 0; j < len; j++) {
                    if (j == i) continue;            // ????????
                    line *lines = line_list[j];
                    int count = obj_list[j]->point_count;
                    for (int q = 0; q < count; q++) {
                        for (int p = 0; p < active_count; p++) {
                            if (cross(lines[q], line_list[i][p])) {
                                is_cross = true;
                                break;
                            }
                        }
                        if (is_cross) break;
                    }
                    if (is_cross) break;
                }
            }

                unsigned long elapsed = get_time() - frame_start;
                if (elapsed < time_per_frame) {
                    sleep_micro(time_per_frame - elapsed);
                };  // ??????????????

                if (frame_count % (int)fps == 0) {
                    printf("??????(%.2f,%.2f) | ¶À???(%.2f,%.2f) | ????(%.2f,%.2f)\n", car.a.x, car.a.y, car.position.x, car.position.y, car.v.x, car.v.y);
                };
                
                if (is_cross) { // ?????????
                    printf("pong!");
                    crush(&car);
                    printf("??????(%.2f,%.2f) | ¶À???(%.2f,%.2f) | ????(%.2f,%.2f)\n", car.a.x, car.a.y, car.position.x, car.position.y, car.v.x, car.v.y);
                };

                if (get_time() - start_time > 1000000 * 20) { // ??????????????20s
                    running_status = false;
                };
            }
        }
    }

    printf("??????\n");
    system("pause");
    return 0;
}